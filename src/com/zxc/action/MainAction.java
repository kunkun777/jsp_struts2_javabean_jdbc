package com.zxc.action;
import java.sql.*;
import java.util.*;
import com.zxc.model.vo.*;
import com.zxc.jdbc.SqlSrvDBConn;
import com.opensymphony.xwork2.*;
public class MainAction extends ActionSupport{
	private UserTable user;
	//???????????? execute ????
	public String execute() throws Exception{
		String usr=user.getUsername();			//????????????
		String pwd=user.getPassword();			//???????????
		boolean validated=false;				//?????????
		SqlSrvDBConn sqlsrvdb=new SqlSrvDBConn();
		ActionContext context=ActionContext.getContext();
		Map session=context.getSession();		//???????????????????????????? 
		UserTable user1=null;
		//???? UserTable ????????????η?????????????????????????????????????????Σ????????????????????????????????????
		user1=(UserTable)session.get("user");
		//???????????ν?????????δ?? user1 ?????????? null
		if(user1==null){
			//??? userTable ???е???
    		String sql="select * from userTable";
    		ResultSet rs=sqlsrvdb.executeQuery(sql);		//???????
    		try {
				while(rs.next())
				{
					if((rs.getString("username").trim().compareTo(usr)==0)&&(rs.getString("password").compareTo(pwd)==0)){
						user1=new UserTable();				//?????????? JavaBean ???? user1
						user1.setId(rs.getInt(1));
						user1.setUsername(rs.getString(2));
						user1.setPassword(rs.getString(3));
						session.put("user", user1);			//?? user1 ??????????
						validated=true;						//???? true ????????????
					}
				}
	    		rs.close();
			} catch (SQLException e) {
				e.printStackTrace();
			}
    		sqlsrvdb.closeStmt();
    		sqlsrvdb.closeConn();
		}
        else{
        	validated=true;
        }
        if(validated)
        {
        	//???????????????"success"
        	return "success";
        }
        else{
            //??????????????"error"
        	return "error";
        }
		
	}
	public  void validate(){
		if (user.getUsername()==null||user.getUsername().trim().equals(""))
			addFieldError("user.username","用户名必须填写！");
	}
	public UserTable getUser(){
		return user;
	}
	public void setUser(UserTable user){
		this.user=user;
	}
}
